name: Reusable Test

# SPDX-License-Identifier: MIT
# Copyright (c) 2025 scalable_echo_server_demo contributors

on:
  workflow_call:
    inputs:
      build_dir:
        required: false
        type: string
        default: build
      artifact_name:
        required: false
        type: string
        default: build-artifacts
      config:
        required: false
        type: string
        default: Release

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: downloaded_build/${{ inputs.build_dir }}

      - name: Verify downloaded build
        run: |
          if (-not (Test-Path "./downloaded_build/${{ inputs.build_dir }}")) {
            Write-Host "Downloaded build not found; failing"
            exit 1
          }

      - name: Run loopback test
        shell: pwsh
        run: |
          # Start the server in background on port 5000 (use explicit flags)
          $serverPath = Resolve-Path "./downloaded_build/${{ inputs.build_dir }}/${{ inputs.config }}/echo_server.exe"
          $clientPath = Resolve-Path "./downloaded_build/${{ inputs.build_dir }}/${{ inputs.config }}/echo_client.exe"
          $server = Start-Process -FilePath $serverPath -ArgumentList "--port", "5000", "--cores", "1" -PassThru -NoNewWindow

          # Wait for server to start
          Start-Sleep -Seconds 2

          try {
            # Run client test for 60 seconds with 1 worker (use new flag-style CLI)
            $clientOutput = & $clientPath "--server" "127.0.0.1" "--port" "5000" "--payload" "64" "--cores" "1" "--duration" "60" 2>&1
            $clientExitCode = $LASTEXITCODE

            Write-Host "Client output:"
            Write-Host $clientOutput

            # Parse results to verify packets were sent and received
            $output = $clientOutput -join "`n"

            if ($output -match "Packets sent: (\d+)") {
              $sent = [int]$matches[1]
              Write-Host "Packets sent: $sent"
            }

            if ($output -match "Packets received: (\d+)") {
              $received = [int]$matches[1]
              Write-Host "Packets received: $received"
            }

            # Verify we sent and received packets
            if ($sent -gt 0 -and $received -gt 0) {
              Write-Host "Test PASSED: Successfully sent $sent packets and received $received responses"
              $testPassed = $true
            } else {
              Write-Host "Test FAILED: No packets exchanged (sent=$sent, received=$received)"
              $testPassed = $false
            }

            # Check drop rate is acceptable (< 50% for loopback)
            if ($sent -gt 0) {
              $dropRate = (($sent - $received) / $sent) * 100
              Write-Host "Drop rate: $dropRate%"
              if ($dropRate -gt 50) {
                Write-Host "Warning: High drop rate detected"
              }
            }

          } finally {
            # Stop the server
            if ($server -and !$server.HasExited) {
              Stop-Process -Id $server.Id -Force -ErrorAction SilentlyContinue
            }
          }

          if (-not $testPassed) {
            exit 1
          }

      - name: Archive build artifacts
        if: failure()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: build-artifacts
